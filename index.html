<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE å­¸ç¿’ç¥å™¨ - Duoè²“é ­é·¹ç›£ç£ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .duo-mascot {
            text-align: center;
            font-size: 4em;
            margin-bottom: 20px;
        }

        .motivation {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .subject-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .subject-btn {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .subject-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .quiz-builder {
            background: #f9f9f9;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .option-input input {
            flex: 1;
        }

        .image-upload {
            margin-top: 10px;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .quiz-list {
            display: grid;
            gap: 15px;
        }

        .quiz-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .quiz-card:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .quiz-info h3 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .quiz-meta {
            color: #666;
            font-size: 0.9em;
        }

        .quiz-actions {
            display: flex;
            gap: 10px;
        }

        .quiz-mode {
            text-align: center;
        }

        .question-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            border: 3px solid #667eea;
        }

        .question-number {
            color: #667eea;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 1.3em;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .question-image {
            max-width: 100%;
            max-height: 300px;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .choice-btn {
            padding: 15px 20px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            text-align: left;
            transition: all 0.3s;
        }

        .choice-btn:hover {
            background: #e8e8e8;
            border-color: #667eea;
        }

        .choice-btn.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .choice-btn.wrong {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .long-answer {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .score-board {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .score-value {
            font-size: 2em;
            font-weight: bold;
        }

        .feedback {
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.wrong {
            background: #f8d7da;
            color: #721c24;
        }

        .flashcard {
            background: white;
            border-radius: 20px;
            padding: 50px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.5s;
            border: 3px solid #667eea;
            position: relative;
        }

        .flashcard.flipped {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-content {
            font-size: 1.5em;
            text-align: center;
            line-height: 1.6;
        }

        .flashcard-hint {
            position: absolute;
            bottom: 20px;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .results {
            text-align: center;
            padding: 40px;
        }

        .results h2 {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .final-score {
            font-size: 4em;
            font-weight: bold;
            color: #764ba2;
            margin-bottom: 20px;
        }

        .roast {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .bounce {
            animation: bounce 0.5s;
        }

        .hide {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="duo-mascot">ğŸ¦‰</div>
        <h1>DSE å­¸ç¿’ç¥å™¨</h1>
        <div class="motivation" id="motivation"> 40æ—¥å€’æ•¸ï¼Œå””å¥½ç©å•¦ï¼Œå¿«å•²æº«æ›¸ï¼ğŸ’€</div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('manage')">ç®¡ç†é¡Œåº«</button>
            <button class="tab-btn" onclick="switchTab('quiz')">åšæ¸¬é©—</button>
            <button class="tab-btn" onclick="switchTab('flashcard')">Flashcard</button>
            <button class="tab-btn" onclick="switchTab('stats')">éŒ¯é¡Œå›é¡§</button>
        </div>

        <!-- ç®¡ç†é¡Œåº« -->
        <div id="manage-tab" class="tab-content active">
            <div style="margin-bottom: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="exportData()" style="background: #28a745;">ğŸ’¾ Export å‚™ä»½</button>
                <button onclick="document.getElementById('import-file').click()" style="background: #17a2b8;">ğŸ“‚ Import åŒ¯å…¥</button>
                <input type="file" id="import-file" accept=".json" onchange="importData(event)" style="display: none;">
            </div>

            <div class="subject-selector" id="subject-selector">
                <button class="subject-btn" onclick="selectSubject('Econ')">ğŸ“Š ç¶“æ¿Ÿ Econ</button>
                <button class="subject-btn" onclick="selectSubject('Eng')">ğŸ‡¬ğŸ‡§ è‹±æ–‡ English</button>
                <button class="subject-btn" onclick="selectSubject('ä¸­å²')">ğŸ“œ ä¸­å²</button>
                <button class="subject-btn" onclick="selectSubject('ä¸­æ–‡')">âœï¸ ä¸­æ–‡</button>
                <button class="subject-btn" onclick="selectSubject('M2')">ğŸ”¢ M2</button>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <div style="background: #f9f9f9; padding: 20px; border-radius: 15px; display: inline-block; max-width: 500px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">âœ¨ è‡ªè¨‚ç§‘ç›®/Topic</h3>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                        ä¾‹å¦‚ï¼šEcon - Market Structureã€ä¸­å² - è¾›äº¥é©å‘½ã€M2 - Integration
                    </p>
                    <input type="text" id="custom-subject" placeholder="è¼¸å…¥ç§‘ç›®åç¨±ï¼ˆå¯ä»¥åŠ topicï¼‰" 
                           style="width: 100%; margin-bottom: 10px;">
                    <button onclick="selectCustomSubject()">â• é–‹å§‹åŠ é¡Œç›®</button>
                </div>
            </div>

            <div id="quiz-builder" class="quiz-builder hide">
                <h2>æ–°å¢é¡Œç›® - <span id="current-subject"></span></h2>
                
                <div class="form-group">
                    <label>é¡Œç›®é¡å‹</label>
                    <select id="question-type" onchange="toggleQuestionType()">
                        <option value="mc">Multiple Choice</option>
                        <option value="long">Long Question</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>é¡Œç›®</label>
                    <textarea id="question-text" placeholder="è¼¸å…¥é¡Œç›®..."></textarea>
                    <div class="image-upload">
                        <label>ä¸Šå‚³åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
                        <input type="file" id="question-image" accept="image/*" onchange="previewImage(this, 'question-preview')">
                        <img id="question-preview" class="image-preview hide">
                    </div>
                </div>

                <div id="mc-section">
                    <div class="form-group">
                        <label>é¸é …ï¼ˆæ¯è¡Œä¸€å€‹ï¼Œæ­£ç¢ºç­”æ¡ˆç”¨ * é–‹é ­ï¼‰</label>
                        <textarea id="options-text" placeholder="ä¾‹å¦‚ï¼š&#10;* æ­£ç¢ºç­”æ¡ˆ&#10;éŒ¯èª¤é¸é …1&#10;éŒ¯èª¤é¸é …2&#10;éŒ¯èª¤é¸é …3"></textarea>
                    </div>
                </div>

                <div id="long-section" class="hide">
                    <div class="form-group">
                        <label>åƒè€ƒç­”æ¡ˆ</label>
                        <textarea id="answer-text" placeholder="è¼¸å…¥åƒè€ƒç­”æ¡ˆ..."></textarea>
                    </div>
                </div>

                <button onclick="addQuestion()">â• åŠ é¡Œç›®</button>
                <button class="btn-secondary" onclick="cancelAdd()">å–æ¶ˆ</button>
            </div>

            <div id="quiz-list" class="quiz-list"></div>
        </div>

        <!-- åšæ¸¬é©— -->
        <div id="quiz-tab" class="tab-content">
            <div id="quiz-select">
                <h2>é¸æ“‡ç§‘ç›®é–‹å§‹æ¸¬é©—</h2>
                <div class="subject-selector" id="quiz-subject-selector"></div>
            </div>

            <div id="quiz-mode" class="quiz-mode hide">
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">åˆ†æ•¸</div>
                        <div class="score-value" id="score">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">é€£çºŒç­”å•±</div>
                        <div class="score-value" id="streak">0</div>
                    </div>
                    <div class="score-item">
                        <div class="score-label">é€²åº¦</div>
                        <div class="score-value" id="progress-text">0/0</div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progress-bar" style="width: 0%">0%</div>
                </div>

                <div id="question-container"></div>
                <div id="feedback-container"></div>

                <div id="quiz-actions" style="text-align: center; margin-top: 20px;">
                    <button onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
                    <button class="btn-danger" onclick="quitQuiz()">é€€å‡ºæ¸¬é©—</button>
                </div>

                <div id="results" class="results hide"></div>
            </div>
        </div>

        <!-- Flashcard -->
        <div id="flashcard-tab" class="tab-content">
            <div id="flashcard-select">
                <h2>é¸æ“‡ç§‘ç›®é–‹å§‹Flashcard</h2>
                <div class="subject-selector" id="flashcard-subject-selector"></div>
            </div>

            <div id="flashcard-mode" class="hide">
                <div class="score-board">
                    <div class="score-item">
                        <div class="score-label">å·²æº«</div>
                        <div class="score-value" id="flashcard-progress">0/0</div>
                    </div>
                </div>

                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-content" id="flashcard-content"></div>
                    <div class="flashcard-hint">é»æ“Šç¿»å¡ / æŒ‰ Space</div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="nextFlashcard()">ä¸‹ä¸€å¼µ â¡ï¸</button>
                    <button class="btn-danger" onclick="quitFlashcard()">é€€å‡º</button>
                </div>
            </div>
        </div>

        <!-- éŒ¯é¡Œå›é¡§ -->
        <div id="stats-tab" class="tab-content">
            <h2>éŒ¯é¡Œå›é¡§</h2>
            <div id="wrong-questions-list"></div>
        </div>
    </div>

    <script>
        // Sound Effects
        const correctSound = () => {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77eafTRAMUKfj8LZjHAY4ktjyzHksBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSR6y/HcizsLGGS47OahURALTKXi8LdlHwU2jdX0zocsBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU2jdXxz3kpBSh+zPLaizsKGGS57OihUBELTKXh8bllHgU=');
            audio.play().catch(e => console.log('Sound play failed'));
        };

        const wrongSound = () => {
            const audio = new Audio('data:audio/wav;base64,UklGRmQEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YUAEAAD/////AgD+/wAA/f8CAAAA/v8BAAAA//8AAAAAAAD//wEAAAD+/wAA//8AAP7/AQAAAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA//8AAP//AAD//wAA');
            audio.play().catch(e => console.log('Sound play failed'));
        };

        const flipSound = () => {
            const audio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=');
            audio.play().catch(e => console.log('Sound play failed'));
        };

        // Data Structure
        let quizData = JSON.parse(localStorage.getItem('quizData')) || {};
        let wrongQuestions = JSON.parse(localStorage.getItem('wrongQuestions')) || {};
        let currentSubject = '';
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let streak = 0;
        let isAnswered = false;

        // Initialize
        function init() {
            loadQuizList();
            updateMotivation();
            setInterval(updateMotivation, 10000);
        }

        function updateMotivation() {
            const daysLeft = Math.ceil((new Date('2025-04-09') - new Date()) / (1000 * 60 * 60 * 24));
            const roasts = [
                `ä»²æœ‰${daysLeft}æ—¥DSEï¼Œä½ åšç·Šä¹œï¼ŸğŸ’€`,
                `${daysLeft}æ—¥å¾Œå°±è€ƒè©¦å•¦ï¼Œå¿«å•²æº«æ›¸ï¼ğŸ¦‰`,
                `åœï¼Œå””å¥½å†æ‹–å•¦ï¼ä»²æœ‰${daysLeft}æ—¥ï¼âš ï¸`,
                `ä½ ä»¥ç‚ºè‡ªå·±å¥½å‹ï¼Ÿ${daysLeft}æ—¥å¾Œè¦‹çœŸç« ï¼ğŸ’ª`,
                `${daysLeft}æ—¥å€’æ•¸ï¼Œå””å¥½ç©å•¦ï¼ğŸ“š`
            ];
            document.getElementById('motivation').textContent = roasts[Math.floor(Math.random() * roasts.length)];
        }

        // Tab Switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');

            if (tab === 'quiz') {
                loadQuizSubjects();
            } else if (tab === 'flashcard') {
                loadFlashcardSubjects();
            } else if (tab === 'stats') {
                loadWrongQuestions();
            }
        }

        // Subject Selection
        function selectSubject(subject) {
            currentSubject = subject;
            document.getElementById('current-subject').textContent = subject;
            document.getElementById('subject-selector').classList.add('hide');
            document.getElementById('quiz-builder').classList.remove('hide');
            loadQuizList();
        }

        function selectCustomSubject() {
            const customInput = document.getElementById('custom-subject').value.trim();
            if (!customInput) {
                alert('è«‹è¼¸å…¥ç§‘ç›®åç¨±ï¼');
                return;
            }
            selectSubject(customInput);
            document.getElementById('custom-subject').value = '';
        }

        function cancelAdd() {
            document.getElementById('quiz-builder').classList.add('hide');
            document.getElementById('subject-selector').classList.remove('hide');
            clearForm();
        }

        function toggleQuestionType() {
            const type = document.getElementById('question-type').value;
            if (type === 'mc') {
                document.getElementById('mc-section').classList.remove('hide');
                document.getElementById('long-section').classList.add('hide');
            } else {
                document.getElementById('mc-section').classList.add('hide');
                document.getElementById('long-section').classList.remove('hide');
            }
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hide');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Add Question
        function addQuestion() {
            const type = document.getElementById('question-type').value;
            const questionText = document.getElementById('question-text').value.trim();
            const questionImage = document.getElementById('question-preview').src;

            if (!questionText) {
                alert('è«‹è¼¸å…¥é¡Œç›®ï¼');
                return;
            }

            const question = {
                id: Date.now(),
                type: type,
                question: questionText,
                image: questionImage !== location.href ? questionImage : null,
                wrongCount: 0
            };

            if (type === 'mc') {
                const optionsText = document.getElementById('options-text').value.trim();
                if (!optionsText) {
                    alert('è«‹è¼¸å…¥é¸é …ï¼');
                    return;
                }

                const lines = optionsText.split('\n').filter(line => line.trim());
                const options = [];
                let correctAnswer = -1;

                lines.forEach((line, index) => {
                    if (line.startsWith('*')) {
                        correctAnswer = index;
                        options.push(line.substring(1).trim());
                    } else {
                        options.push(line.trim());
                    }
                });

                if (correctAnswer === -1) {
                    alert('è«‹ç”¨ * æ¨™è¨˜æ­£ç¢ºç­”æ¡ˆï¼');
                    return;
                }

                question.options = options;
                question.correctAnswer = correctAnswer;
            } else {
                const answerText = document.getElementById('answer-text').value.trim();
                if (!answerText) {
                    alert('è«‹è¼¸å…¥åƒè€ƒç­”æ¡ˆï¼');
                    return;
                }
                question.answer = answerText;
            }

            if (!quizData[currentSubject]) {
                quizData[currentSubject] = [];
            }
            quizData[currentSubject].push(question);
            
            localStorage.setItem('quizData', JSON.stringify(quizData));
            
            clearForm();
            loadQuizList();
            
            alert('âœ… åŠ å’—é¡Œç›®ï¼ç¹¼çºŒåŠªåŠ›ï¼');
        }

        function clearForm() {
            document.getElementById('question-text').value = '';
            document.getElementById('options-text').value = '';
            document.getElementById('answer-text').value = '';
            document.getElementById('question-preview').classList.add('hide');
            document.getElementById('question-preview').src = '';
        }

        function loadQuizList() {
            const container = document.getElementById('quiz-list');
            container.innerHTML = '';

            Object.keys(quizData).forEach(subject => {
                const questions = quizData[subject];
                if (questions.length === 0) return;

                const card = document.createElement('div');
                card.className = 'quiz-card';
                card.innerHTML = `
                    <div class="quiz-info">
                        <h3>${subject}</h3>
                        <div class="quiz-meta">${questions.length} æ¢é¡Œç›®</div>
                    </div>
                    <div class="quiz-actions">
                        <button onclick="viewQuestions('${subject}')">æŸ¥çœ‹é¡Œç›®</button>
                        <button class="btn-danger" onclick="deleteSubject('${subject}')">åˆªé™¤</button>
                    </div>
                `;
                container.appendChild(card);
            });

            if (container.innerHTML === '') {
                container.innerHTML = '<p style="text-align: center; color: #666;">æœªæœ‰é¡Œç›®ï¼Œå¿«å•²åŠ é¡Œç›®ï¼</p>';
            }
        }

        function viewQuestions(subject) {
            const questions = quizData[subject];
            let html = `<h3>${subject} é¡Œç›®åˆ—è¡¨</h3>`;
            
            questions.forEach((q, index) => {
                html += `
                    <div class="quiz-card">
                        <div class="quiz-info">
                            <div><strong>Q${index + 1}:</strong> ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}</div>
                            <div class="quiz-meta">${q.type === 'mc' ? 'Multiple Choice' : 'Long Question'} | éŒ¯${q.wrongCount}æ¬¡</div>
                        </div>
                        <div class="quiz-actions">
                            <button class="btn-danger" onclick="deleteQuestion('${subject}', ${index})">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });

            const modal = confirm(html + '\n\næŒ‰ç¢ºå®šè¿”å›');
            if (modal) {
                loadQuizList();
            }
        }

        function deleteQuestion(subject, index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤å‘¢æ¢é¡Œç›®ï¼Ÿ')) {
                quizData[subject].splice(index, 1);
                if (quizData[subject].length === 0) {
                    delete quizData[subject];
                }
                localStorage.setItem('quizData', JSON.stringify(quizData));
                loadQuizList();
            }
        }

        function deleteSubject(subject) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤${subject}æ‰€æœ‰é¡Œç›®ï¼Ÿ`)) {
                delete quizData[subject];
                localStorage.setItem('quizData', JSON.stringify(quizData));
                loadQuizList();
            }
        }

        // Quiz Mode
        function loadQuizSubjects() {
            const container = document.getElementById('quiz-subject-selector');
            container.innerHTML = '';

            Object.keys(quizData).forEach(subject => {
                if (quizData[subject].length > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'subject-btn';
                    btn.textContent = `${subject} (${quizData[subject].length}é¡Œ)`;
                    btn.onclick = () => startQuiz(subject);
                    container.appendChild(btn);
                }
            });
        }

        function startQuiz(subject) {
            currentSubject = subject;
            currentQuiz = [...quizData[subject]];
            
            // Add wrong questions for this subject
            if (wrongQuestions[subject]) {
                wrongQuestions[subject].forEach(wq => {
                    if (wq.wrongCount < 3) {
                        currentQuiz.push(wq);
                    }
                });
            }

            // Shuffle
            currentQuiz.sort(() => Math.random() - 0.5);
            
            currentQuestionIndex = 0;
            score = 0;
            streak = 0;
            
            document.getElementById('quiz-select').classList.add('hide');
            document.getElementById('quiz-mode').classList.remove('hide');
            
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestionIndex >= currentQuiz.length) {
                showResults();
                return;
            }

            isAnswered = false;
            const question = currentQuiz[currentQuestionIndex];
            const container = document.getElementById('question-container');
            
            let html = `
                <div class="question-card">
                    <div class="question-number">ç¬¬ ${currentQuestionIndex + 1} é¡Œ / ${currentQuiz.length}</div>
                    <div class="question-text">${question.question}</div>
            `;

            if (question.image) {
                html += `<img src="${question.image}" class="question-image">`;
            }

            if (question.type === 'mc') {
                html += '<div class="choices">';
                question.options.forEach((option, index) => {
                    html += `<button class="choice-btn" onclick="checkAnswer(${index})">${option}</button>`;
                });
                html += '</div>';
            } else {
                html += `
                    <textarea id="user-answer" class="long-answer" placeholder="è¼¸å…¥ä½ å˜…ç­”æ¡ˆ..."></textarea>
                    <button onclick="checkLongAnswer()">æäº¤ç­”æ¡ˆ</button>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
            
            document.getElementById('feedback-container').innerHTML = '';
            updateScore();
        }

        function checkAnswer(selectedIndex) {
            if (isAnswered) return;
            isAnswered = true;

            const question = currentQuiz[currentQuestionIndex];
            const choices = document.querySelectorAll('.choice-btn');
            
            if (selectedIndex === question.correctAnswer) {
                choices[selectedIndex].classList.add('correct');
                correctSound();
                score += 10;
                streak++;
                showFeedback(true);
            } else {
                choices[selectedIndex].classList.add('wrong');
                choices[question.correctAnswer].classList.add('correct');
                wrongSound();
                streak = 0;
                addToWrongQuestions(question);
                showFeedback(false);
            }

            updateScore();
        }

        function checkLongAnswer() {
            if (isAnswered) return;
            isAnswered = true;

            const question = currentQuiz[currentQuestionIndex];
            const userAnswer = document.getElementById('user-answer').value.trim();
            
            if (!userAnswer) {
                alert('è«‹è¼¸å…¥ç­”æ¡ˆï¼');
                isAnswered = false;
                return;
            }

            const feedback = `
                <div class="feedback">
                    <div><strong>ä½ å˜…ç­”æ¡ˆï¼š</strong></div>
                    <div>${userAnswer}</div>
                    <div style="margin-top: 20px;"><strong>åƒè€ƒç­”æ¡ˆï¼š</strong></div>
                    <div>${question.answer}</div>
                    <div style="margin-top: 20px;">
                        <button onclick="markCorrect()">âœ… ç­”å•±å’—</button>
                        <button class="btn-danger" onclick="markWrong()">âŒ ç­”éŒ¯å’—</button>
                    </div>
                </div>
            `;
            
            document.getElementById('feedback-container').innerHTML = feedback;
        }

        function markCorrect() {
            correctSound();
            score += 10;
            streak++;
            updateScore();
            showFeedback(true);
        }

        function markWrong() {
            wrongSound();
            streak = 0;
            const question = currentQuiz[currentQuestionIndex];
            addToWrongQuestions(question);
            updateScore();
            showFeedback(false);
        }

        function showFeedback(isCorrect) {
            const roasts = {
                correct: [
                    'ğŸ‰ ä¼°ä½ å””åˆ°ä½ éƒ½ç­”å¾—å•±ï¼',
                    'âœ¨ å¥½å–ï¼Œç¹¼çºŒåŠªåŠ›ï¼',
                    'ğŸ’ª å””éŒ¯å–ï¼Œä¿æŒè½å»ï¼',
                    'ğŸ”¥ ä½ çœŸä¿‚æœ‰è®€æ›¸å–ï¼',
                    'â­ å»ä»”/å¥³ï¼',
                ],
                wrong: [
                    'ğŸ’€ éŒ¯æ™’ï¼Œè¿”å»æº«æ›¸å•¦ï¼',
                    'ğŸ˜± å’éƒ½éŒ¯ï¼ŸèªçœŸå•²å•¦ï¼',
                    'ğŸ¦‰ æˆ‘éƒ½å””çŸ¥é»è¬›ä½ å¥½...',
                    'âš ï¸ éŒ¯åˆ°é›¢æ™’è­œï¼',
                    'ğŸ˜¤ ä½ æœ‰ç„¡æº«æ›¸æ¶ï¼Ÿ',
                ]
            };

            const messages = isCorrect ? roasts.correct : roasts.wrong;
            const message = messages[Math.floor(Math.random() * messages.length)];
            
            const feedback = document.createElement('div');
            feedback.className = `feedback ${isCorrect ? 'correct bounce' : 'wrong shake'}`;
            feedback.textContent = message;
            
            document.getElementById('feedback-container').appendChild(feedback);
        }

        function addToWrongQuestions(question) {
            if (!wrongQuestions[currentSubject]) {
                wrongQuestions[currentSubject] = [];
            }

            const existing = wrongQuestions[currentSubject].find(q => q.id === question.id);
            if (existing) {
                existing.wrongCount++;
            } else {
                question.wrongCount = 1;
                wrongQuestions[currentSubject].push({...question});
            }

            localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('streak').textContent = streak;
            document.getElementById('progress-text').textContent = `${currentQuestionIndex + 1}/${currentQuiz.length}`;
            
            const progress = ((currentQuestionIndex + 1) / currentQuiz.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
            document.getElementById('progress-bar').textContent = Math.round(progress) + '%';
        }

        function nextQuestion() {
            if (!isAnswered && currentQuiz[currentQuestionIndex].type === 'mc') {
                alert('æ€å€‹ç­”æ¡ˆå…ˆå•¦ï¼');
                return;
            }

            currentQuestionIndex++;
            showQuestion();
        }

        function showResults() {
            const percentage = Math.round((score / (currentQuiz.length * 10)) * 100);
            
            let roast = '';
            if (percentage >= 90) {
                roast = 'ğŸ† å˜©ï¼Œä½ çœŸä¿‚æœ‰æ–™åˆ°ï¼ç¹¼çºŒä¿æŒï¼';
            } else if (percentage >= 70) {
                roast = 'ğŸ‘ å””éŒ¯å–ï¼Œä½†ä»²æœ‰é€²æ­¥ç©ºé–“ï¼';
            } else if (percentage >= 50) {
                roast = 'ğŸ˜ ä¸€èˆ¬å•¦ï¼Œå†åŠªåŠ›å•²ï¼';
            } else {
                roast = 'ğŸ’€ ä½ çœŸä¿‚æœ‰æº«æ›¸ï¼Ÿå¿«å•²è¿”å»æº«å•¦ï¼';
            }

            const html = `
                <h2>æ¸¬é©—å®Œæˆï¼</h2>
                <div class="final-score">${percentage}%</div>
                <div class="roast">${roast}</div>
                <div style="font-size: 1.2em; margin-bottom: 20px;">
                    ç¸½åˆ†ï¼š${score} / ${currentQuiz.length * 10}<br>
                    æœ€é•·é€£çºŒç­”å•±ï¼š${streak} é¡Œ
                </div>
                <button onclick="quitQuiz()">è¿”å›</button>
            `;

            document.getElementById('results').innerHTML = html;
            document.getElementById('results').classList.remove('hide');
            document.getElementById('question-container').classList.add('hide');
            document.getElementById('quiz-actions').classList.add('hide');
        }

        function quitQuiz() {
            document.getElementById('quiz-select').classList.remove('hide');
            document.getElementById('quiz-mode').classList.add('hide');
            document.getElementById('results').classList.add('hide');
            document.getElementById('question-container').classList.remove('hide');
            document.getElementById('quiz-actions').classList.remove('hide');
        }

        // Flashcard Mode
        function loadFlashcardSubjects() {
            const container = document.getElementById('flashcard-subject-selector');
            container.innerHTML = '';

            Object.keys(quizData).forEach(subject => {
                if (quizData[subject].length > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'subject-btn';
                    btn.textContent = `${subject} (${quizData[subject].length}å¼µ)`;
                    btn.onclick = () => startFlashcard(subject);
                    container.appendChild(btn);
                }
            });
        }

        let flashcardDeck = [];
        let flashcardIndex = 0;
        let isFlipped = false;

        function startFlashcard(subject) {
            currentSubject = subject;
            flashcardDeck = [...quizData[subject]];
            flashcardDeck.sort(() => Math.random() - 0.5);
            flashcardIndex = 0;
            isFlipped = false;

            document.getElementById('flashcard-select').classList.add('hide');
            document.getElementById('flashcard-mode').classList.remove('hide');
            
            showFlashcard();
        }

        function showFlashcard() {
            if (flashcardIndex >= flashcardDeck.length) {
                alert('âœ… å®Œæˆæ™’æ‰€æœ‰flashcardï¼');
                quitFlashcard();
                return;
            }

            const card = flashcardDeck[flashcardIndex];
            const flashcard = document.getElementById('flashcard');
            const content = document.getElementById('flashcard-content');
            
            flashcard.classList.remove('flipped');
            isFlipped = false;
            
            let html = card.question;
            if (card.image) {
                html = `<img src="${card.image}" style="max-width: 100%; max-height: 200px; margin-bottom: 20px;">` + html;
            }
            content.innerHTML = html;
            
            document.getElementById('flashcard-progress').textContent = `${flashcardIndex + 1}/${flashcardDeck.length}`;
        }

        function flipCard() {
            const card = flashcardDeck[flashcardIndex];
            const flashcard = document.getElementById('flashcard');
            const content = document.getElementById('flashcard-content');
            
            flipSound();
            
            if (!isFlipped) {
                flashcard.classList.add('flipped');
                if (card.type === 'mc') {
                    content.innerHTML = `<strong>ç­”æ¡ˆï¼š</strong>${card.options[card.correctAnswer]}`;
                } else {
                    content.innerHTML = `<strong>åƒè€ƒç­”æ¡ˆï¼š</strong><br>${card.answer}`;
                }
                isFlipped = true;
            } else {
                flashcard.classList.remove('flipped');
                content.innerHTML = card.question;
                isFlipped = false;
            }
        }

        function nextFlashcard() {
            flashcardIndex++;
            showFlashcard();
        }

        function quitFlashcard() {
            document.getElementById('flashcard-select').classList.remove('hide');
            document.getElementById('flashcard-mode').classList.add('hide');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !document.getElementById('flashcard-mode').classList.contains('hide')) {
                e.preventDefault();
                flipCard();
            }
        });

        // Wrong Questions Review
        function loadWrongQuestions() {
            const container = document.getElementById('wrong-questions-list');
            container.innerHTML = '';

            let hasWrongQuestions = false;

            Object.keys(wrongQuestions).forEach(subject => {
                const questions = wrongQuestions[subject];
                if (questions.length === 0) return;

                hasWrongQuestions = true;

                const section = document.createElement('div');
                section.innerHTML = `<h3>${subject} - ${questions.length} æ¢éŒ¯é¡Œ</h3>`;
                
                questions.forEach((q, index) => {
                    const card = document.createElement('div');
                    card.className = 'quiz-card';
                    card.innerHTML = `
                        <div class="quiz-info">
                            <div><strong>Q:</strong> ${q.question}</div>
                            <div class="quiz-meta">éŒ¯å’— ${q.wrongCount} æ¬¡</div>
                            ${q.type === 'mc' ? `<div style="margin-top: 10px;"><strong>ç­”æ¡ˆï¼š</strong>${q.options[q.correctAnswer]}</div>` : ''}
                        </div>
                        <div class="quiz-actions">
                            <button onclick="practiceWrongQuestion('${subject}', ${index})">ç·´ç¿’</button>
                            <button class="btn-danger" onclick="removeWrongQuestion('${subject}', ${index})">ç§»é™¤</button>
                        </div>
                    `;
                    section.appendChild(card);
                });

                container.appendChild(section);
            });

            if (!hasWrongQuestions) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš«æ™‚ç„¡éŒ¯é¡Œï¼Œç¹¼çºŒåŠªåŠ›ï¼ğŸ’ª</p>';
            }
        }

        function practiceWrongQuestion(subject, index) {
            currentSubject = subject;
            currentQuiz = [wrongQuestions[subject][index]];
            currentQuestionIndex = 0;
            score = 0;
            streak = 0;

            switchTab('quiz');
            document.getElementById('quiz-select').classList.add('hide');
            document.getElementById('quiz-mode').classList.remove('hide');
            showQuestion();
        }

        function removeWrongQuestion(subject, index) {
            if (confirm('ç¢ºå®šè¦ç§»é™¤å‘¢æ¢éŒ¯é¡Œï¼Ÿ')) {
                wrongQuestions[subject].splice(index, 1);
                if (wrongQuestions[subject].length === 0) {
                    delete wrongQuestions[subject];
                }
                localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                loadWrongQuestions();
            }
        }

        // Export / Import Functions
        function exportData() {
            const data = {
                quizData: quizData,
                wrongQuestions: wrongQuestions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `DSE-Quiz-Backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('âœ… å‚™ä»½æˆåŠŸï¼è¨˜å¾—keepå¥½å€‹fileï¼');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.quizData) {
                        alert('âŒ å‘¢å€‹å””ä¿‚æœ‰æ•ˆå˜…backup fileï¼');
                        return;
                    }

                    const confirmMsg = 'âš ï¸ Importæœƒè¦†è“‹ç¾æœ‰dataï¼\n\nä½ è€Œå®¶æœ‰ï¼š\n' + 
                        Object.keys(quizData).map(s => `${s}: ${quizData[s].length}é¡Œ`).join('\n') +
                        '\n\nç¢ºå®šè¦è¦†è“‹ï¼Ÿ';

                    if (Object.keys(quizData).length > 0 && !confirm(confirmMsg)) {
                        return;
                    }

                    // Merge or replace
                    const mergeChoice = confirm('æ’³ã€Œç¢ºå®šã€= åˆä½µdataï¼ˆä¿ç•™èˆŠ+æ–°ï¼‰\næ’³ã€Œå–æ¶ˆã€= å®Œå…¨è¦†è“‹ï¼ˆåˆªæ™’èˆŠdataï¼‰');
                    
                    if (mergeChoice) {
                        // Merge mode
                        Object.keys(data.quizData).forEach(subject => {
                            if (!quizData[subject]) {
                                quizData[subject] = [];
                            }
                            data.quizData[subject].forEach(q => {
                                // Check for duplicates by question text
                                const exists = quizData[subject].find(existing => 
                                    existing.question === q.question
                                );
                                if (!exists) {
                                    quizData[subject].push(q);
                                }
                            });
                        });

                        if (data.wrongQuestions) {
                            Object.keys(data.wrongQuestions).forEach(subject => {
                                if (!wrongQuestions[subject]) {
                                    wrongQuestions[subject] = [];
                                }
                                data.wrongQuestions[subject].forEach(q => {
                                    const exists = wrongQuestions[subject].find(existing => 
                                        existing.id === q.id
                                    );
                                    if (!exists) {
                                        wrongQuestions[subject].push(q);
                                    }
                                });
                            });
                        }
                    } else {
                        // Replace mode
                        quizData = data.quizData;
                        wrongQuestions = data.wrongQuestions || {};
                    }

                    localStorage.setItem('quizData', JSON.stringify(quizData));
                    localStorage.setItem('wrongQuestions', JSON.stringify(wrongQuestions));
                    
                    loadQuizList();
                    
                    const totalQuestions = Object.values(quizData).reduce((sum, arr) => sum + arr.length, 0);
                    alert(`âœ… ImportæˆåŠŸï¼\n\nç¸½å…±ï¼š${totalQuestions}æ¢é¡Œç›®\nç§‘ç›®ï¼š${Object.keys(quizData).length}å€‹`);
                    
                } catch (error) {
                    alert('âŒ Importå¤±æ•—ï¼Fileå¯èƒ½æå£ã€‚\n\nError: ' + error.message);
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
